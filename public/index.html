<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vinyl407</title>
<style>
  :root{
    --bg:#0e1512; --bg2:#0a110e;
    --paper:#efe8d2; --muted:#cbbfa5;
    --brass:#c8b685; --brass2:#a18f63;
    --shadow:rgba(0,0,0,.48);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%; overflow:hidden; overscroll-behavior:none}
  body{
    background:
      radial-gradient(1400px 900px at 12% -12%, #1a2922 0%, var(--bg) 58%),
      linear-gradient(180deg, var(--bg2), var(--bg));
    color:var(--paper);
    font:16px/1.45 "Georgia","Times New Roman",serif;
    display:flex;align-items:center;justify-content:center;padding:26px;
  }
  .wrap{width:min(1120px,96vw); height:100%; overflow:hidden}
  .head{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px}
  .head h1{font-size:26px;color:var(--brass);text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .row{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;margin-bottom:14px}
  input[type=text]{
    padding:10px 12px;border-radius:10px;
    border:1px solid var(--brass2);
    background:rgba(240,236,224,.08);
    color:var(--paper);font:15px "Georgia","Times New Roman",serif;
  }
  .btn{
    padding:8px 12px;border-radius:10px;cursor:pointer;
    background:transparent;color:var(--paper);
    border:1px solid rgba(193,176,130,.45);
    font-weight:700;font-size:13px;
  }
  .btn:hover{background:rgba(239,232,210,.08)}
  .err{color:#e8a2a2;min-height:18px;margin-top:8px}
  .desk{display:grid;grid-template-columns:1.25fr 0.75fr;gap:18px}
  @media (max-width:980px){.desk{grid-template-columns:1fr}}
  .plinth{
    position:relative;aspect-ratio:16/10;padding:26px;border-radius:14px;overflow:hidden;
    background:
      linear-gradient(145deg, rgba(255,255,255,.05), rgba(0,0,0,.22)),
      linear-gradient(110deg, #5b4134, #3a2a22 68%),
      repeating-linear-gradient(10deg, rgba(0,0,0,.22) 0 2px, rgba(0,0,0,0) 2px 12px),
      repeating-linear-gradient(95deg, rgba(255,255,255,.05) 0 1px, transparent 1px 7px);
    background-blend-mode:overlay,normal,multiply,normal;
    border:1px solid rgba(0,0,0,.55);
    box-shadow:0 36px 80px var(--shadow), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  .feet{
    position:absolute;left:24px;right:24px;bottom:0;height:10px;
    background:
      radial-gradient(40% 120% at 20% 50%, rgba(0,0,0,.55), transparent),
      radial-gradient(40% 120% at 80% 50%, rgba(0,0,0,.55), transparent);
    filter:blur(.8px);
  }
  .platter-wrap{
    position:absolute;left:28px;top:50%;width:56%;aspect-ratio:1;
    transform:translateY(-50%);pointer-events:none;
  }
  .platter{
    width:100%;height:100%;border-radius:50%;
    background:
      conic-gradient(from -18deg,
        rgba(255,255,255,.16) 0 10deg, rgba(0,0,0,0) 10deg 182deg,
        rgba(255,255,255,.13) 182deg 194deg, rgba(0,0,0,0) 194deg 360deg),
      radial-gradient(circle at 50% 48%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 56%),
      radial-gradient(circle at 33% 33%, #262626 0%, #0b0b0b 66%),
      radial-gradient(circle at center, transparent 61.8%, rgba(0,0,0,.82) 62.2%),
      repeating-radial-gradient(circle at center, rgba(255,255,255,.028) 0 2px, rgba(0,0,0,0) 2px 4px);
    box-shadow:0 18px 38px rgba(0,0,0,.52), inset 0 0 0 1px rgba(255,255,255,.05);
    will-change:transform;backface-visibility:hidden;transform:translateZ(0);
  }
  .platter.spin{animation:spin 1.85s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  .label{
    position:absolute;inset:35.5% 35.5%;border-radius:50%;overflow:hidden;
    display:flex;align-items:center;justify-content:center;
    border:1px solid #3d5146;
    background:radial-gradient(circle at 40% 35%, #24372f, #14231c);
    color:#d9cfb4;font-weight:700;letter-spacing:.06em;text-transform:uppercase;
  }
  .label .art{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.92}
  .spindle{
    position:absolute;inset:49% 49%;border-radius:50%;
    background:radial-gradient(circle, #beb091, #5a5242);
    box-shadow:0 0 6px rgba(0,0,0,.5);
  }
  .arm-base{position:absolute;right:8.8%;top:22%;width:22%;height:22%}
  .pivot{
    position:absolute;right:0;top:0;width:84px;height:84px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #ece7db, #a8a39a 70%, #6f6a62);
    box-shadow:inset 0 0 6px rgba(0,0,0,.35), 0 10px 26px rgba(0,0,0,.45);
    border:1px solid rgba(0,0,0,.4);
  }
  .arm{
    --angle:24deg;
    --lift:-22px;
    position:absolute;right:38px;top:38px;width:280px;height:16px;
    transform-origin:240px 8px;
    transform:translateY(var(--lift)) rotate(var(--angle));
    transition:transform 240ms cubic-bezier(.22,1,.36,1);
    filter:drop-shadow(0 6px 8px rgba(0,0,0,.45));
  }
  .tube{
    position:absolute;left:0;top:0;width:240px;height:16px;border-radius:8px;
    background:linear-gradient(180deg,#e0dbd0,#9c968d);
    box-shadow:inset 0 -2px 2px rgba(0,0,0,.26), inset 0 2px 2px rgba(255,255,255,.42);
  }
  .headshell{
    position:absolute;left:240px;top:3px;width:40px;height:12px;border-radius:6px;
    background:linear-gradient(180deg,#d9d4c9,#8f8a81);
    box-shadow:inset 0 -1px 1px rgba(0,0,0,.35), inset 0 1px 1px rgba(255,255,255,.45);
  }
  .stylus{
    position:absolute;left:278px;top:7px;width:6px;height:6px;border-radius:50%;
    background:#111;box-shadow:0 0 0 2px #d0cabf inset;
  }
  .sleeve-wrap{
    border:1px solid var(--brass2);border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.22));
    box-shadow:0 24px 60px var(--shadow), inset 0 0 0 1px rgba(255,255,255,.05);
    padding:12px;display:flex;flex-direction:column;align-items:center;
  }
  .sleeve{
    position:relative;width:min(420px,90%);aspect-ratio:1/1;
    transform:perspective(1200px) rotateY(-16deg) rotateZ(-1.4deg) translateZ(0);
    border-radius:12px;border:1px solid rgba(0,0,0,.55);
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.2));
    box-shadow:-20px 30px 52px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.05);
    overflow:hidden;will-change:transform;backface-visibility:hidden;
  }
  .sleeve .art{position:absolute;inset:12px;border-radius:10px;background-size:cover;background-position:center;box-shadow:0 0 0 1px rgba(0,0,0,.35)}
  .ringwear{
    position:absolute;inset:12px;border-radius:10px;pointer-events:none;
    background:
      radial-gradient(118% 92% at 50% 30%, rgba(0,0,0,.34), rgba(0,0,0,0) 60%),
      radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.07), rgba(255,255,255,0) 66%);
  }
  .meta{margin-top:10px;color:var(--muted);text-align:center;min-height:22px;font-size:13px}
  #player{position:absolute;width:0;height:0;overflow:hidden;pointer-events:none}
</style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1>Vinyl407</h1>
      <small style="color:var(--brass)">LP 33 1/3</small>
    </div>

    <div class="row">
      <input id="yt" type="text" placeholder="https://www.youtube.com/watch?v=... ou playlist &list=...">
      <button id="play"  class="btn">Play</button>
      <button id="pause" class="btn">Pause</button>
      <button id="next"  class="btn">Prox</button>
    </div>
    <div id="err" class="err"></div>

    <div class="desk">
      <div class="plinth">
        <div class="platter-wrap">
          <div class="platter" id="platter">
            <div class="label"><div class="art" id="labelArt"></div>LP</div>
            <div class="spindle"></div>
          </div>
        </div>
        <div class="arm-base">
          <div class="pivot"></div>
          <div class="arm" id="arm">
            <div class="tube"></div>
            <div class="headshell"></div>
            <div class="stylus"></div>
          </div>
        </div>
        <div class="feet"></div>
      </div>

      <div class="sleeve-wrap">
        <div class="sleeve">
          <div class="art" id="sleeveArt"></div>
          <div class="ringwear"></div>
        </div>
        <div id="meta" class="meta"></div>
      </div>
    </div>

    <div id="player"></div>
  </div>

<script>
const $ = s => document.querySelector(s);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

const elInput=$('#yt'), elPlay=$('#play'), elPause=$('#pause'), elNext=$('#next'), elErr=$('#err'), elMeta=$('#meta');
const platter=$('#platter'), arm=$('#arm'), labelArt=$('#labelArt'), sleeveArt=$('#sleeveArt');

let ctx, ana, master, am, lfo, lfo2, hum1, hum2, rb, rGain;
let crackleBus = null;
let player=null, loaded=false;
let armAngle=24;

const ARM_MIN=-6, ARM_MAX=24, ARM_INNER=-2;
const VINYL={
  base:0.072,
  duck:0.55,
  gapBoost:2.3,
  hissLPF:9200,
  shelfHiGain:-2.4,
  wowHz:0.5556,
  wowDepth:0.007,
  fltHz:6.0,
  fltDepth:0.0024,
  hum1Gain:0.0019,
  hum2Gain:0.0011,
  rumbleGain:0.0038
};
const GAP_MS=3200;

function ensureCtx(){
  if(!ctx){
    ctx=new (window.AudioContext||window.webkitAudioContext)();
    ana=ctx.createAnalyser();
    ana.fftSize=1024;
  }
  if(ctx.state==='suspended') ctx.resume();
}
function pinkBuf(sec){
  const sr=ctx.sampleRate,n=sr*sec,b=ctx.createBuffer(1,n,sr),d=b.getChannelData(0);
  let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
  for(let i=0;i<n;i++){
    const w=Math.random()*2-1;
    b0=0.99886*b0+w*0.0555179;
    b1=0.99332*b1+w*0.0750759;
    b2=0.969*b2+w*0.153852;
    b3=0.8665*b3+w*0.3104856;
    b4=0.55*b4+w*0.5329522;
    b5=-0.7616*b5-w*0.016898;
    d[i]=(b0+b1+b2+b3+b4+b5+b6+w*0.5362)*0.11;
    b6=w*0.115926;
  }
  return b;
}
function rumbleBuf(sec){
  const sr=ctx.sampleRate,n=sr*sec,b=ctx.createBuffer(1,n,sr),d=b.getChannelData(0);
  for(let i=0;i<n;i++){
    let v=0;
    v+=Math.sin(2*Math.PI*25*i/sr)*0.3;
    v+=Math.sin(2*Math.PI*33*i/sr)*0.2;
    v+=(Math.random()*2-1)*0.1;
    d[i]=v*0.15;
  }
  return b;
}
function startNoise(){
  ensureCtx();
  const pink=ctx.createBufferSource(); pink.buffer=pinkBuf(4); pink.loop=true;
  const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=VINYL.hissLPF;
  const shelf=ctx.createBiquadFilter(); shelf.type='highshelf'; shelf.frequency.value=10000; shelf.gain.value=VINYL.shelfHiGain;
  am=ctx.createGain(); am.gain.value=1.0;

  lfo=ctx.createOscillator(); lfo.frequency.value=VINYL.wowHz; const g1=ctx.createGain(); g1.gain.value=VINYL.wowDepth; lfo.connect(g1).connect(am.gain);
  lfo2=ctx.createOscillator(); lfo2.frequency.value=VINYL.fltHz; const g2=ctx.createGain(); g2.gain.value=VINYL.fltDepth; lfo2.connect(g2).connect(am.gain);

  hum1=ctx.createOscillator(); hum1.frequency.value=60; const h1=ctx.createGain(); h1.gain.value=VINYL.hum1Gain; hum1.connect(h1).connect(am);
  hum2=ctx.createOscillator(); hum2.frequency.value=120; const h2=ctx.createGain(); h2.gain.value=VINYL.hum2Gain; hum2.connect(h2).connect(am);

  rb=ctx.createBufferSource(); rb.buffer=rumbleBuf(4); rb.loop=true; rGain=ctx.createGain(); rGain.gain.value=VINYL.rumbleGain; rb.connect(rGain).connect(am);

  master=ctx.createGain(); master.gain.value=VINYL.base;

  crackleBus = ctx.createGain();
  crackleBus.gain.value = 1.4;  /* AQUI ESTÁ O VOLUME DO ESTALO. SOBE SE QUISER MAIS. */
  crackleBus.connect(ctx.destination);

  pink.connect(lp); lp.connect(shelf); shelf.connect(am); am.connect(master); master.connect(ana); ana.connect(ctx.destination);
  [pink,lfo,lfo2,hum1,hum2,rb].forEach(n=>n.start());
}

/* estalo realista */
function vinylClickReal(strong=false){
  if(!ctx || !crackleBus) return;
  const sr = ctx.sampleRate;
  const dur = strong ? 0.055 : 0.038;
  const n = Math.floor(sr * dur);
  const buf = ctx.createBuffer(1, n, sr);
  const ch = buf.getChannelData(0);

  for (let i = 0; i < n; i++){
    const t = i / n;
    const env = Math.exp(-32 * t);
    const noise = (Math.random()*2 - 1);
    ch[i] = noise * env;
    if (i < 4) ch[i] += (strong ? 1.1 : 0.75) * (1 - i/4);
  }

  const src = ctx.createBufferSource();
  src.buffer = buf;

  const hp = ctx.createBiquadFilter();
  hp.type = 'highpass';
  hp.frequency.value = 1100 + Math.random()*900;

  const lp = ctx.createBiquadFilter();
  lp.type = 'lowpass';
  lp.frequency.value = 5200 + Math.random()*1200;

  const g = ctx.createGain();
  g.gain.setValueAtTime(1, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);

  const subOsc = ctx.createOscillator();
  const subGain = ctx.createGain();
  subOsc.frequency.value = 140 + Math.random()*80;
  subGain.gain.setValueAtTime(strong ? 0.32 : 0.16, ctx.currentTime);
  subGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.055);
  subOsc.connect(subGain).connect(crackleBus);
  subOsc.start();
  subOsc.stop(ctx.currentTime + 0.07);

  src.connect(hp).connect(lp).connect(g).connect(crackleBus);
  src.start();
  src.stop(ctx.currentTime + dur + 0.01);
}

/* burst ao pausar */
function vinylCrackleBurst(){
  const total = 6 + Math.floor(Math.random()*4); // 6 a 9
  for (let i = 0; i < total; i++){
    const t = 40 + Math.random()*160; // 40 a 200 ms
    setTimeout(()=>{
      if (i === 0) vinylClickReal(true);
      else vinylClickReal(false);
    }, t);
  }
}

/* YouTube */
function parseYT(s){
  s=(s||'').trim();
  const mL=s.match(/[?&]list=([^&]+)/); if(mL) return {list:mL[1]};
  if(/^PL[0-9A-Za-z_-]+$/.test(s)) return {list:s};
  const mV=s.match(/[?&]v=([^&]+)/); if(mV) return {videoId:mV[1]};
  const mS=s.match(/youtu\.be\/([^?]+)/); if(mS) return {videoId:mS[1]};
  if(/^[A-Za-z0-9_-]{11}$/.test(s)) return {videoId:s};
  return null;
}
function loadYT(){
  return new Promise((res,rej)=>{
    if(window.YT && window.YT.Player){ return res(); }
    const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api';
    tag.onerror=()=>rej('Falha ao carregar YouTube IFrame API');
    window.onYouTubeIframeAPIReady=()=>{ res(); };
    document.head.appendChild(tag);
  });
}
function bestThumb(id){
  return new Promise(resolve=>{
    const hi=`https://i.ytimg.com/vi/${id}/maxresdefault.jpg`;
    const lo=`https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
    const img=new Image();
    img.onload=()=>resolve(img.width>=1280?hi:lo);
    img.onerror=()=>resolve(lo);
    img.src=hi;
  });
}
function updateArt(id){
  bestThumb(id).then(url=>{
    labelArt.style.backgroundImage=`url('${url}')`;
    sleeveArt.style.backgroundImage=`url('${url}')`;
  });
}
function syncPauseLabel(isPlaying){
  elPause.textContent = isPlaying ? 'Pause' : 'Resume';
}
function initPlayer(){
  const origin=location.origin;
  player=new YT.Player('player',{
    width:0,height:0,videoId:'',
    playerVars:{modestbranding:1,rel:0,playsinline:1,origin},
    events:{
      onStateChange:(e)=>{
        if(!master||!ctx) return;
        if(e.data===YT.PlayerState.PLAYING){
          needleDown();
          master.gain.setTargetAtTime(VINYL.base*VINYL.duck, ctx.currentTime, 0.08);
          platter.classList.add('spin');
          syncPauseLabel(true);
          followProgress();
          const d=player.getVideoData?.();
          if(d && d.video_id){
            updateArt(d.video_id);
            elMeta.textContent = d.title || '';
          }
        }else if(e.data===YT.PlayerState.PAUSED){
          needleUp();
          platter.classList.remove('spin');
          master.gain.setTargetAtTime(VINYL.base, ctx.currentTime, 0.12);
          syncPauseLabel(false);
        }else if(e.data===YT.PlayerState.ENDED){
          needleUp();
          platter.classList.remove('spin');
          master.gain.setTargetAtTime(VINYL.base*VINYL.gapBoost, ctx.currentTime, 0.08);
          syncPauseLabel(false);
          const pl=player.getPlaylist?.();
          if(pl && pl.length){
            setTimeout(()=>{ try{ player.nextVideo(); }catch{} }, GAP_MS);
          }
        }
      },
      onError:(e)=>{ if(e?.data===2) return; elErr.textContent='YouTube: '+e.data; }
    }
  });
}

/* braço */
function setArmAngle(deg){ armAngle = clamp(deg, ARM_MIN, ARM_MAX); arm.style.setProperty('--angle', armAngle + 'deg'); }
function armToStart(){ setArmAngle(ARM_MAX); }
function armToProgress(t){ const ang=ARM_MAX-(ARM_MAX-ARM_INNER)*t; setArmAngle(ang); }
function needleDown(){ arm.style.setProperty('--lift','0px'); }
function needleUp(){ arm.style.setProperty('--lift','-22px'); }

/* UI */
function setErr(m){ elErr.textContent=m||''; }
async function ensureEnv(){ ensureCtx(); if(!master) startNoise(); await loadYT(); if(!player) initPlayer(); }

async function doPlay(){
  setErr('');
  await ensureEnv();
  const txt=elInput.value.trim();
  if(!txt && !loaded){ setErr('Cole um link do YouTube.'); return; }
  if(txt){
    const p=parseYT(txt); if(!p){ setErr('Link ou ID invalido.'); return; }
    if(p.list) player.loadPlaylist({list:p.list,listType:'playlist'}); else player.loadVideoById(p.videoId);
    loaded=true;
  }
  needleUp();
  armToStart();
  platter.classList.add('spin');
  setTimeout(()=>{ needleDown(); try{ player.playVideo(); }catch{} }, 240);
  syncPauseLabel(true);
}

function doPauseToggle(){
  if(!player) return;
  const st = player.getPlayerState ? player.getPlayerState() : -1;
  if(st === 1){
    try{ player.pauseVideo(); }catch{}
    needleUp();
    platter.classList.remove('spin');
    if(master && ctx) master.gain.setTargetAtTime(VINYL.base, ctx.currentTime, 0.12);
    vinylCrackleBurst();
    syncPauseLabel(false);
  } else {
    try{ player.playVideo(); }catch{}
    platter.classList.add('spin');
    needleDown();
    if(master && ctx) master.gain.setTargetAtTime(VINYL.base*VINYL.duck, ctx.currentTime, 0.08);
    syncPauseLabel(true);
  }
}

function doNext(){
  if(!player) return;
  needleUp();
  platter.classList.remove('spin');
  if(master&&ctx) master.gain.setTargetAtTime(VINYL.base*VINYL.gapBoost, ctx.currentTime, 0.08);
  setTimeout(()=>{
    try{
      const pl = player.getPlaylist && player.getPlaylist();
      if(pl && pl.length) { player.nextVideo(); }
      else {
        const c = player.getCurrentTime();
        player.seekTo(c+12, true);
        player.playVideo();
      }
    }catch{}
  }, GAP_MS);
  syncPauseLabel(true);
}

let raf;
function followProgress(){
  cancelAnimationFrame(raf);
  const step=()=>{
    if(!player || player.getPlayerState?.()!==1) return;
    const dur=player.getDuration?.(); const cur=player.getCurrentTime?.();
    if(dur>0){ armToProgress(cur/dur); }
    raf=requestAnimationFrame(step);
  };
  raf=requestAnimationFrame(step);
}

(function boot(){
  ensureCtx();
  startNoise();
  setArmAngle(24);
  needleUp();
})();
elPlay.addEventListener('click', doPlay);
elPause.addEventListener('click', doPauseToggle);
elNext.addEventListener('click', doNext);
elInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doPlay(); });
</script>
</body>
</html>
