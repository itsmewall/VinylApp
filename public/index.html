<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Phonographe — Old Money</title>
<style>
  :root{ --bg:#0f1613; --paper:#efe8d2; --gold:#cbb98e; --gold2:#a09073; --ink:#1b1a17; --shadow:rgba(0,0,0,.45); }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:
      radial-gradient(1400px 900px at 10% -10%, #192720 0%, var(--bg) 58%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 2px, transparent 2px 4px);
    color:var(--paper);
    font:16px/1.45 "Georgia","Times New Roman",serif;
    display:flex;align-items:center;justify-content:center;padding:26px;
  }
  .wrap{width:min(1100px,96vw)}
  .head{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px}
  .head h1{font-size:28px;color:var(--gold);letter-spacing:.03em;text-shadow:0 1px 0 rgba(0,0,0,.3)}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  input[type=text]{flex:1;padding:12px 14px;border-radius:8px;border:1px solid var(--gold2);background:rgba(246,241,230,.07);color:var(--paper)}
  .btn{padding:12px 18px;border-radius:8px;border:1px solid var(--gold2);background:linear-gradient(180deg,#e6dfca,#cfc3a0);color:var(--ink);font-weight:700;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.18)}
  .muted{color:#cbbfa5;font-size:14px}
  .err{color:#e8a2a2;min-height:18px;margin-top:6px}

  .desk{display:grid;grid-template-columns:1.08fr .92fr;gap:18px}
  @media (max-width:960px){.desk{grid-template-columns:1fr}}

  /* Plinto “madeira” sem data URI */
  .plinth{
    position:relative;aspect-ratio:16/10;padding:28px;border-radius:12px;
    background:
      linear-gradient(145deg, rgba(255,255,255,.05), rgba(0,0,0,.25)),
      linear-gradient(110deg, #5b4134, #3a2a22 70%),
      repeating-linear-gradient(12deg, rgba(0,0,0,.22) 0 2px, rgba(0,0,0,0) 2px 12px),
      repeating-linear-gradient(96deg, rgba(255,255,255,.05) 0 1px, transparent 1px 7px);
    background-blend-mode:overlay,normal,multiply,normal;
    border:1px solid rgba(0,0,0,.55);
    box-shadow:0 40px 90px var(--shadow), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  .feet{position:absolute;left:24px;right:24px;bottom:-10px;height:14px;background:
    radial-gradient(40% 120% at 20% 50%, rgba(0,0,0,.6), transparent),
    radial-gradient(40% 120% at 80% 50%, rgba(0,0,0,.6), transparent);filter:blur(1px)}

  /* Prato/disco com sulcos e reflexo */
  .platter{
    position:absolute;left:28px;top:28px;width:58%;aspect-ratio:1;border-radius:50%;
    background:
      conic-gradient(from -20deg, rgba(255,255,255,.14) 0 12deg, rgba(0,0,0,0) 12deg 180deg, rgba(255,255,255,.12) 180deg 192deg, rgba(0,0,0,0) 192deg 360deg),
      radial-gradient(circle at 50% 48%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 55%),
      radial-gradient(circle at 33% 33%, #2a2a2a 0%, #0c0c0c 66%),
      radial-gradient(circle at center, transparent 62%, rgba(0,0,0,.78) 63%),
      repeating-radial-gradient(circle at center, rgba(255,255,255,.028) 0 2.05px, rgba(0,0,0,0) 2.05px 4.1px);
    box-shadow:0 20px 40px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.05);
  }
  .platter.spin{animation:spin 1.8s linear infinite}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

  .label{position:absolute;inset:36% 36%;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:1px solid #3d5146;background:radial-gradient(circle at 40% 35%, #263a30, #14231c);color:#d9cfb4;font-weight:700;letter-spacing:.06em;text-transform:uppercase}
  .label .art{position:absolute;inset:0;background-size:cover;background-position:center;opacity:.92}
  .spindle{position:absolute;inset:48.9% 48.9%;border-radius:50%;background:radial-gradient(circle,#bfb397,#5b5343);box-shadow:0 0 6px rgba(0,0,0,.5)}

  /* braço/agulha */
  .arm-base{position:absolute;right:10%;top:22%;width:22%;height:22%}
  .pivot{position:absolute;right:0;top:0;width:84px;height:84px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #ece7db, #a8a39a 70%, #6f6a62);
    box-shadow:inset 0 0 6px rgba(0,0,0,.35),0 10px 26px rgba(0,0,0,.45);border:1px solid rgba(0,0,0,.4)}
  .arm{position:absolute;right:38px;top:38px;width:280px;height:16px;transform-origin:240px 8px;transform:rotate(24deg);filter:drop-shadow(0 6px 8px rgba(0,0,0,.45))}
  .tube{position:absolute;left:0;top:0;width:240px;height:16px;border-radius:8px;background:linear-gradient(180deg,#e0dbd0,#9c968d);box-shadow:inset 0 -2px 2px rgba(0,0,0,.25), inset 0 2px 2px rgba(255,255,255,.4)}
  .headshell{position:absolute;left:240px;top:3px;width:40px;height:12px;border-radius:6px;background:linear-gradient(180deg,#d9d4c9,#8f8a81);box-shadow:inset 0 -1px 1px rgba(0,0,0,.35), inset 0 1px 1px rgba(255,255,255,.45)}
  .stylus{position:absolute;left:278px;top:7px;width:6px;height:6px;border-radius:50%;background:#111;box-shadow:0 0 0 2px #d0cabf inset}

  /* capa 3D */
  .sleeve{
    position:relative; aspect-ratio:1/1; width:min(420px,92%);
    margin:18px auto 0; transform:perspective(1200px) rotateY(-18deg) rotateZ(-2deg);
    border-radius:12px; border:1px solid rgba(0,0,0,.55);
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.22));
    box-shadow: -26px 36px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.05);
    overflow:hidden;
  }
  .sleeve .art{position:absolute;inset:10px;border-radius:10px;background-size:cover;background-position:center;box-shadow:0 0 0 1px rgba(0,0,0,.35)}
  .ringwear{position:absolute;inset:10px;border-radius:10px;pointer-events:none;background:
    radial-gradient(120% 90% at 50% 30%, rgba(0,0,0,.38), rgba(0,0,0,0) 60%),
    radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,.07), rgba(255,255,255,0) 65%)}

  .panel{border:1px solid var(--gold2);border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.2));padding:16px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1>Phonographe</h1>
      <small style="color:#b8aa84">LP 33⅓ • madeira & metal</small>
    </div>

    <div class="row">
      <input id="yt" type="text" placeholder="https://www.youtube.com/watch?v=... ou playlist &list=...">
      <button id="play" class="btn">Play / Pause</button>
    </div>
    <div class="muted">Um clique: liga, gira, posiciona a agulha e toca. Playlist tem pausa com ruído entre faixas.</div>
    <div id="err" class="err"></div>

    <div class="desk">
      <div class="plinth" id="plinth">
        <div class="platter" id="platter">
          <div class="label"><div class="art" id="labelArt"></div>LP</div>
          <div class="spindle"></div>
        </div>
        <div class="arm-base">
          <div class="pivot"></div>
          <div class="arm" id="arm">
            <div class="tube"></div>
            <div class="headshell"></div>
            <div class="stylus"></div>
          </div>
        </div>
        <div class="feet"></div>
      </div>

      <div class="panel">
        <div class="sleeve">
          <div class="art" id="sleeveArt"></div>
          <div class="ringwear"></div>
        </div>
        <div id="meta" class="muted" style="margin-top:10px">Meta: —</div>
      </div>
    </div>

    <div id="player" style="width:0;height:0;overflow:hidden;"></div>
  </div>

<script>
/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

/* refs */
const elInput=$('#yt'), elPlay=$('#play'), elErr=$('#err'), elMeta=$('#meta');
const platter=$('#platter'), arm=$('#arm'), labelArt=$('#labelArt'), sleeveArt=$('#sleeveArt');

/* estado */
let ctx, ana, master, am, lfo, lfo2, hum1, hum2;
let player=null, loaded=false, playing=false;
let armAngle=24;                // repouso
const ARM_MIN=-6, ARM_MAX=24, ARM_INNER=-2;
const VINYL={ base:0.08, duck:0.55, gapBoost:2.4, hissLPF:9200, shelfHiGain:-2.5, wowHz:0.5556, wowDepth:0.007, fltHz:6.0, fltDepth:0.0025, hum1Gain:0.0020, hum2Gain:0.0012, rumbleGain:0.004 };
const GAP_MS=3500;

/* áudio */
function ensureCtx(){ if(!ctx){ ctx=new (window.AudioContext||window.webkitAudioContext)(); ana=ctx.createAnalyser(); ana.fftSize=1024; } if(ctx.state==='suspended') ctx.resume(); }
function pinkBuf(sec){ const sr=ctx.sampleRate,n=sr*sec,b=ctx.createBuffer(1,n,sr),d=b.getChannelData(0); let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
  for(let i=0;i<n;i++){ const w=Math.random()*2-1; b0=0.99886*b0+w*0.0555179;b1=0.99332*b1+w*0.0750759;b2=0.969*b2+w*0.153852;b3=0.8665*b3+w*0.3104856;b4=0.55*b4+w*0.5329522;b5=-0.7616*b5-w*0.016898; d[i]=(b0+b1+b2+b3+b4+b5+b6+w*0.5362)*0.11; b6=w*0.115926;} return b; }
function rumbleBuf(sec){ const sr=ctx.sampleRate,n=sr*sec,b=ctx.createBuffer(1,n,sr),d=b.getChannelData(0); for(let i=0;i<n;i++){ let v=0; v+=Math.sin(2*Math.PI*25*i/sr)*0.3; v+=Math.sin(2*Math.PI*33*i/sr)*0.2; v+=(Math.random()*2-1)*0.1; d[i]=v*0.15; } return b; }
function startNoise(){
  ensureCtx();
  const pink=ctx.createBufferSource(); pink.buffer=pinkBuf(4); pink.loop=true;
  const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=VINYL.hissLPF;
  const shelf=ctx.createBiquadFilter(); shelf.type='highshelf'; shelf.frequency.value=10000; shelf.gain.value=VINYL.shelfHiGain;
  am=ctx.createGain(); am.gain.value=1.0;
  lfo=ctx.createOscillator(); lfo.frequency.value=VINYL.wowHz; const g1=ctx.createGain(); g1.gain.value=VINYL.wowDepth; lfo.connect(g1).connect(am.gain);
  lfo2=ctx.createOscillator(); lfo2.frequency.value=VINYL.fltHz; const g2=ctx.createGain(); g2.gain.value=VINYL.fltDepth; lfo2.connect(g2).connect(am.gain);
  hum1=ctx.createOscillator(); hum1.frequency.value=60; const h1=ctx.createGain(); h1.gain.value=VINYL.hum1Gain; hum1.connect(h1).connect(am);
  hum2=ctx.createOscillator(); hum2.frequency.value=120; const h2=ctx.createGain(); h2.gain.value=VINYL.hum2Gain; hum2.connect(h2).connect(am);
  const rb=ctx.createBufferSource(); rb.buffer=rumbleBuf(4); rb.loop=true; const rGain=ctx.createGain(); rGain.gain.value=VINYL.rumbleGain; rb.connect(rGain).connect(am);
  master=ctx.createGain(); master.gain.value=VINYL.base;
  pink.connect(lp); lp.connect(shelf); shelf.connect(am); am.connect(master); master.connect(ana); ana.connect(ctx.destination);
  [pink,lfo,lfo2,hum1,hum2,rb].forEach(n=>n.start());
}

/* YouTube */
function parseYT(s){
  s=(s||'').trim();
  const mL=s.match(/[?&]list=([^&]+)/); if(mL) return {list:mL[1]};
  if(/^PL[0-9A-Za-z_-]+$/.test(s)) return {list:s};
  const mV=s.match(/[?&]v=([^&]+)/); if(mV) return {videoId:mV[1]};
  const mS=s.match(/youtu\.be\/([^?]+)/); if(mS) return {videoId:mS[1]};
  if(/^[A-Za-z0-9_-]{11}$/.test(s)) return {videoId:s};
  return null;
}
function loadYT(){ return new Promise((res,rej)=>{ if(window.YT&&window.YT.Player) return res(); const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; tag.onerror=()=>rej('Falha ao carregar YouTube IFrame API'); window.onYouTubeIframeAPIReady=()=>res(); document.head.appendChild(tag); }); }
function bestThumb(id){ return new Promise((resolve)=>{ const hi=`https://i.ytimg.com/vi/${id}/maxresdefault.jpg`; const lo=`https://i.ytimg.com/vi/${id}/hqdefault.jpg`; const img=new Image(); img.onload=()=>resolve(img.width>=1280?hi:lo); img.onerror=()=>resolve(lo); img.src=hi; }); }
function updateArt(id){ bestThumb(id).then(url=>{ labelArt.style.backgroundImage=`url('${url}')`; sleeveArt.style.backgroundImage=`url('${url}')`; }); }
function initPlayer(){
  const origin=location.origin;
  player=new YT.Player('player',{
    width:320,height:180,videoId:'',playerVars:{modestbranding:1,rel:0,playsinline:1,origin},
    events:{
      onReady:()=>{/* pronto */},
      onStateChange:(e)=>{
        if(!master||!ctx) return;
        if(e.data===YT.PlayerState.PLAYING){
          master.gain.setTargetAtTime(VINYL.base*VINYL.duck, ctx.currentTime, 0.08);
          platter.classList.add('spin'); playing=true; followProgress();
          const d=player.getVideoData?.(); if(d&&d.video_id){ updateArt(d.video_id); elMeta.textContent=d.title||'—'; }
        }else if(e.data===YT.PlayerState.PAUSED){
          master.gain.setTargetAtTime(VINYL.base, ctx.currentTime, 0.12);
          platter.classList.remove('spin'); playing=false;
        }else if(e.data===YT.PlayerState.ENDED){
          platter.classList.remove('spin'); playing=false;
          master.gain.setTargetAtTime(VINYL.base*VINYL.gapBoost, ctx.currentTime, 0.08);
          const pl=player.getPlaylist?.(); if(pl&&pl.length) setTimeout(()=>{ try{ player.nextVideo(); }catch{} }, GAP_MS);
        }
      },
      onError:(e)=>{ const map={2:'Parâmetro inválido',5:'HTML5 error',100:'Removido/privado',101:'Bloqueado p/ incorporação',150:'Bloqueado p/ incorporação'}; setErr(map[e.data]||('YouTube: '+e.data)); }
    }
  });
}

/* braço */
function setArm(deg){ armAngle=clamp(deg,ARM_MIN,ARM_MAX); arm.style.transform=`rotate(${armAngle}deg)`; }
function armToStart(){ setArm(ARM_MAX); }
function armToProgress(t){ const ang=ARM_MAX-(ARM_MAX-ARM_INNER)*t; setArm(ang); }

/* UX: um botão */
function setErr(m){ elErr.textContent=m||''; }

async function togglePlay(){
  setErr('');
  ensureCtx(); if(!master) startNoise();

  // carrega YT se necessário
  if(!player){ try{ await loadYT(); initPlayer(); }catch(err){ setErr(String(err)); return; } }

  const txt=elInput.value.trim();
  if(!txt && !loaded){ setErr('Cole um link/ID/playlist do YouTube.'); return; }

  // se tem texto novo e não carregou ainda ou mudou, (re)carrega
  if(txt){
    const p=parseYT(txt); if(!p){ setErr('Link/ID inválido.'); return; }
    if(p.list) player.loadPlaylist({list:p.list,listType:'playlist'}); else player.loadVideoById(p.videoId);
    loaded=true;
  }

  // aciona “mecânica” e tenta tocar
  armToStart();                        // braço vai pra borda do disco
  platter.classList.add('spin');       // prato gira
  try{ player.playVideo(); }catch{}
}

elPlay.addEventListener('click', togglePlay);
elInput.addEventListener('keydown', e=>{ if(e.key==='Enter') togglePlay(); });

/* segue o progresso para mover o braço */
let raf; function followProgress(){
  cancelAnimationFrame(raf);
  const step=()=>{ if(!player||player.getPlayerState?.()!==YT.PlayerState.PLAYING) return;
    const dur=player.getDuration?.(); const cur=player.getCurrentTime?.();
    if(dur>0){ armToProgress(cur/dur); }
    raf=requestAnimationFrame(step);
  };
  raf=requestAnimationFrame(step);
}

/* boot: ruído ambiente, prato parado, braço em repouso */
ensureCtx(); startNoise(); setArm(24);
</script>
</body>
</html>
