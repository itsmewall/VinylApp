<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vinil fiel + YouTube</title>
  <style>
    :root{--bg:#0f1217;--card:rgba(255,255,255,0.06);--bd:rgba(255,255,255,0.12);--txt:#eef2f6;--mut:#9fb0c0;--acc:#76d39b;--acc2:#4cc2ff}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,sans-serif;font-size:15px;line-height:1.5;background:var(--bg);color:var(--txt);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    #app{width:100%;max-width:1200px;background:var(--bg);border-radius:14px;outline:1px solid var(--bd);box-shadow:0 14px 40px rgba(0,0,0,.35);padding:24px}
    .header{text-align:center;margin-bottom:28px}.header h1{font-size:24px;font-weight:600;margin-bottom:6px}.header p{font-size:14px;color:var(--mut)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    .panel{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:20px}
    .panel-title{font-size:16px;font-weight:600;margin-bottom:16px}
    .controls{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
    button{padding:10px 18px;border-radius:8px;border:1px solid var(--bd);background:var(--card);color:var(--txt);font-size:14px;font-weight:500;cursor:pointer;transition:.2s}
    button:hover:not(:disabled){background:rgba(255,255,255,.1);border-color:var(--acc)}button:disabled{opacity:.4;cursor:not-allowed}
    button.primary{background:var(--acc);color:#0f1217;border-color:var(--acc)}
    button.secondary{background:var(--acc2);color:#0f1217;border-color:var(--acc2)}
    .info-text{font-size:13px;color:var(--mut);margin-bottom:12px}.meter{width:100%;height:10px;background:rgba(255,255,255,.08);border-radius:5px;overflow:hidden}
    .meter-bar{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));width:0%;transition:width .05s linear}
    canvas{width:100%;height:160px;background:rgba(0,0,0,.3);border-radius:8px;border:1px solid var(--bd);margin:16px 0}
    input[type=text]{flex:1;min-width:300px;padding:10px 14px;border-radius:8px;border:1px solid var(--bd);background:rgba(0,0,0,.3);color:var(--txt);font-size:14px}
    input[type=text]:focus{outline:none;border-color:var(--acc)}input[type=text]::placeholder{color:var(--mut);opacity:.6}
    #player{width:100%;max-width:320px;height:180px;background:#000;border-radius:8px;border:1px solid var(--bd)}
    .metadata{display:flex;align-items:center;gap:12px;margin-top:16px}
    #cover{width:64px;height:64px;border-radius:8px;border:1px solid var(--bd);object-fit:cover;display:none}
    #cover.show{display:block}.disc{display:inline-block;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#2a2a2a,#0a0a0a);position:relative;margin-top:8px}
    .disc.spinning{animation:spin 1.8s linear infinite}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .disc .grooves{position:absolute;inset:15%;border-radius:50%;background:repeating-radial-gradient(circle at center,transparent 0,transparent 3px,rgba(255,255,255,.03) 3px,rgba(255,255,255,.03) 4px)}
    .disc .label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32%;height:32%;border-radius:50%;background:#1b2230;display:flex;align-items:center;justify-content:center;font-size:10px;color:#9fb0c0;font-weight:600;letter-spacing:1px}
    .tonearm{display:inline-block;width:40%;height:3px;background:linear-gradient(90deg,#4a4a4a,#2a2a2a);border-radius:2px;margin-left:10px;vertical-align:top}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.header p{display:none}input[type=text]{min-width:100%}.controls{flex-direction:column}.controls>*{width:100%}}
    .err{margin-top:8px;color:#ff8891;font-size:13px;min-height:18px}
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <h1>Vinil fiel + YouTube</h1>
      <p>Perfil fixo de LP 33⅓ rpm. Sem frescura.</p>
    </div>

    <div class="grid">
      <!-- Vinil -->
      <div class="panel">
        <h2 class="panel-title">Vinil</h2>
        <div class="controls">
          <button id="vinylToggle" class="primary">Vinil On</button>
        </div>
        <p class="info-text">Medidor = ruído do vinil. Mix final é do seu sistema.</p>
        <div class="meter"><div id="meter" class="meter-bar"></div></div>
        <canvas id="scope" width="800" height="320"></canvas>
        <div class="disc" id="disc"><div class="grooves"></div><div class="label">LP 33⅓</div></div>
        <div class="tonearm" id="tonearm"></div>
      </div>

      <!-- YouTube -->
      <div class="panel">
        <h2 class="panel-title">YouTube</h2>
        <div class="controls"><input id="ytUrl" type="text" placeholder="https://www.youtube.com/watch?v=... ou playlist &list=..." /></div>
        <div class="controls">
          <button id="ytLoad" class="secondary">Carregar</button>
          <button id="ytPlay" class="primary" disabled>Play/Pause</button>
          <button id="ytNext" class="secondary" disabled>Próx</button>
          <button id="ytPrev" class="secondary" disabled>Ant</button>
          <button id="ytTest" class="secondary">Test Video</button>
        </div>
        <div id="player"></div>
        <div class="metadata"><img id="cover" alt="Capa" /><div id="meta"></div></div>
        <div id="ytErr" class="err"></div>
      </div>
    </div>
  </div>

  <script>
  // ===== helpers/log =====
  const log = (...a)=>{ console.log('[APP]', ...a); };
  const showErr = (msg)=>{ const el=document.getElementById('ytErr'); el.textContent=String(msg||''); };

  // ===== DOM refs =====
  const vinylToggle=document.getElementById('vinylToggle');
  const meter=document.getElementById('meter');
  const scope=document.getElementById('scope');
  const disc=document.getElementById('disc');
  const tonearm=document.getElementById('tonearm');
  const ytUrl=document.getElementById('ytUrl');
  const ytLoad=document.getElementById('ytLoad');
  const ytPlay=document.getElementById('ytPlay');
  const ytNext=document.getElementById('ytNext');
  const ytPrev=document.getElementById('ytPrev');
  const ytTest=document.getElementById('ytTest');
  const cover=document.getElementById('cover');
  const meta=document.getElementById('meta');

  // ===== canvas =====
  const scopeCtx=scope.getContext('2d');
  const dpr=window.devicePixelRatio||1; scope.width=800*dpr; scope.height=320*dpr; scopeCtx.scale(dpr,dpr);

  // ===== Audio engine =====
  let ctx, ana, pink, lp, shelf, am, master, lfo, lfo2, hum1, hum2, rsrc, g1, g2, rGain;
  let vinylOn=false, crackleInterval, popInterval, tickInterval, coverInterval;

  const VINYL={ hissLPF:9200, shelfHiGain:-2.5, level:0.08, wowHz:0.5556, wowDepth:0.007,
                fltHz:6.0, fltDepth:0.0025, hum1Gain:0.0020, hum2Gain:0.0012,
                crackleProb:0.45, popProb:0.015, tickMs:1800, rumbleGain:0.004 };
  let baseVinylLevel=VINYL.level; const duckingFactor=0.55;

  function ensureCtx(){ if(!ctx){ ctx=new (window.AudioContext||window.webkitAudioContext)(); ana=ctx.createAnalyser(); ana.fftSize=1024; } if(ctx.state==='suspended') ctx.resume(); }
  function createPinkNoise(s){ const sr=ctx.sampleRate,n=sr*s,b=ctx.createBuffer(1,n,sr),d=b.getChannelData(0); let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    for(let i=0;i<n;i++){ const w=Math.random()*2-1; b0=0.99886*b0+w*0.0555179;b1=0.99332*b1+w*0.0750759;b2=0.969*b2+w*0.153852;b3=0.8665*b3+w*0.3104856;b4=0.55*b4+w*0.5329522;b5=-0.7616*b5-w*0.016898; d[i]=(b0+b1+b2+b3+b4+b5+b6+w*0.5362)*0.11; b6=w*0.115926;} return b;}
  function createRumbleNoise(s){ const sr=ctx.sampleRate,n=sr*s,b=ctx.createBuffer(1,n,sr),d=b.getChannelData(0); for(let i=0;i<n;i++){ let v=0; v+=Math.sin(2*Math.PI*25*i/sr)*0.3; v+=Math.sin(2*Math.PI*33*i/sr)*0.2; v+=(Math.random()*2-1)*0.1; d[i]=v*0.15; } return b;}

  function startVinyl(){ ensureCtx();
    pink=ctx.createBufferSource(); pink.buffer=createPinkNoise(4); pink.loop=true;
    lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=VINYL.hissLPF;
    shelf=ctx.createBiquadFilter(); shelf.type='highshelf'; shelf.frequency.value=10000; shelf.gain.value=VINYL.shelfHiGain;
    am=ctx.createGain(); am.gain.value=1.0;
    lfo=ctx.createOscillator(); lfo.frequency.value=VINYL.wowHz; g1=ctx.createGain(); g1.gain.value=VINYL.wowDepth; lfo.connect(g1).connect(am.gain);
    lfo2=ctx.createOscillator(); lfo2.frequency.value=VINYL.fltHz; g2=ctx.createGain(); g2.gain.value=VINYL.fltDepth; lfo2.connect(g2).connect(am.gain);
    hum1=ctx.createOscillator(); hum1.frequency.value=60; const hum1Gain=ctx.createGain(); hum1Gain.gain.value=VINYL.hum1Gain; hum1.connect(hum1Gain).connect(am);
    hum2=ctx.createOscillator(); hum2.frequency.value=120; const hum2Gain=ctx.createGain(); hum2Gain.gain.value=VINYL.hum2Gain; hum2.connect(hum2Gain).connect(am);
    rsrc=ctx.createBufferSource(); rsrc.buffer=createRumbleNoise(4); rsrc.loop=true; rGain=ctx.createGain(); rGain.gain.value=VINYL.rumbleGain; rsrc.connect(rGain).connect(am);
    master=ctx.createGain(); baseVinylLevel=VINYL.level; master.gain.value=baseVinylLevel;
    pink.connect(lp); lp.connect(shelf); shelf.connect(am); am.connect(master); master.connect(ana); ana.connect(ctx.destination);
    [pink,lfo,lfo2,hum1,hum2,rsrc].forEach(n=>n.start());
    vinylOn=true; vinylToggle.textContent='Vinil Off'; disc.classList.add('spinning');
    crackleInterval=setInterval(()=>{ if(Math.random()<VINYL.crackleProb) playCrackle(); },500);
    popInterval=setInterval(()=>{ if(Math.random()<VINYL.popProb) playPop(); },1000);
    tickInterval=setInterval(()=> playTick(), VINYL.tickMs);
    drawScope(); updateMeter();
  }
  function stopVinyl(){ try{ pink?.stop(); lfo?.stop(); lfo2?.stop(); hum1?.stop(); hum2?.stop(); rsrc?.stop(); }catch{} clearInterval(crackleInterval); clearInterval(popInterval); clearInterval(tickInterval);
    vinylOn=false; vinylToggle.textContent='Vinil On'; disc.classList.remove('spinning'); meter.style.width='0%'; scopeCtx.clearRect(0,0,800,320); }
  function playCrackle(){ if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain(), hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
    o.frequency.value=Math.random()*3000+2000; g.gain.setValueAtTime(0.06,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.02);
    o.connect(hp).connect(g).connect(master); o.start(); o.stop(ctx.currentTime+0.02); }
  function playPop(){ if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain(); o.frequency.value=Math.random()*200+100;
    g.gain.setValueAtTime(0.18,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.05); o.connect(g).connect(master); o.start(); o.stop(ctx.currentTime+0.05); }
  function playTick(){ if(!ctx) return; const o=ctx.createOscillator(), g=ctx.createGain(); o.frequency.value=800; g.gain.setValueAtTime(0.035,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.015); o.connect(g).connect(master); o.start(); o.stop(ctx.currentTime+0.015); }
  function updateMeter(){ if(!vinylOn) return; const a=new Uint8Array(ana.fftSize); ana.getByteTimeDomainData(a); let p=0; for(let i=0;i<a.length;i++){ const v=Math.abs(a[i]-128)/128; if(v>p)p=v; } meter.style.width=Math.min(100,p*220)+'%'; requestAnimationFrame(updateMeter); }
  function drawScope(){ if(!vinylOn) return; const a=new Uint8Array(ana.fftSize); ana.getByteTimeDomainData(a); scopeCtx.clearRect(0,0,800,160); scopeCtx.fillStyle='rgba(0,0,0,.3)'; scopeCtx.fillRect(0,0,800,160);
    scopeCtx.strokeStyle='#76d39b'; scopeCtx.lineWidth=2; scopeCtx.beginPath(); const s=800/a.length; let x=0; for(let i=0;i<a.length;i++){ const y=(a[i]/255)*160; i?scopeCtx.lineTo(x,y):scopeCtx.moveTo(x,y); x+=s; } scopeCtx.stroke(); requestAnimationFrame(drawScope); }
  vinylToggle.addEventListener('click', ()=> vinylOn?stopVinyl():startVinyl());

  // ===== YouTube IFrame (carregamento garantido e com origin) =====
  let ytReady=false, player=null;
  function loadYouTubeAPI(){
    return new Promise((res,rej)=>{
      if(window.YT && window.YT.Player) return res();
      const tag=document.createElement('script');
      tag.src='https://www.youtube.com/iframe_api';
      tag.onerror=()=>rej('Falha ao carregar a YouTube IFrame API');
      window.onYouTubeIframeAPIReady=()=>{ log('YT SDK pronto'); res(); };
      document.head.appendChild(tag);
    });
  }

  function initPlayer(){
    const origin = window.location.origin;
    player = new YT.Player('player',{
      width:320,height:180,videoId:'',
      playerVars:{ modestbranding:1, rel:0, playsinline:1, origin },
      events:{
        onReady:()=>{ ytReady=true; ytPlay.disabled=false; ytNext.disabled=false; ytPrev.disabled=false; log('Player pronto'); startCoverPolling(); },
        onError:(e)=>{ const codes={2:'Parâmetro inválido',5:'HTML5 error',100:'Vídeo removido/privado',101:'Bloqueado para incorporação',150:'Bloqueado para incorporação'}; const msg=codes[e.data]||('Erro YT: '+e.data); showErr(msg); console.warn('YT onError',e); },
        onStateChange:(e)=>{
          const playing = e.data===YT.PlayerState.PLAYING;
          if(master && ctx){ const target = playing ? baseVinylLevel*duckingFactor : baseVinylLevel;
            master.gain.cancelScheduledValues?.(ctx.currentTime);
            master.gain.setTargetAtTime(target, ctx.currentTime, 0.08);
          }
          if(playing) updateMetadata();
        }
      }
    });
  }

  function parseYouTubeUrl(s){
    s=(s||'').trim();
    const mL=s.match(/[?&]list=([^&]+)/); if(mL) return {list:mL[1]};
    if(/^PL[0-9A-Za-z_-]+$/.test(s)) return {list:s};
    const mV=s.match(/[?&]v=([^&]+)/); if(mV) return {videoId:mV[1]};
    const mS=s.match(/youtu\.be\/([^?]+)/); if(mS) return {videoId:mS[1]};
    if(/^[A-Za-z0-9_-]{11}$/.test(s)) return {videoId:s};
    return null;
  }

  function ytEnsureReady(){ return new Promise((res,rej)=>{ let t=0; const i=setInterval(()=>{ if(ytReady){clearInterval(i);res();} if(++t>60){clearInterval(i);rej('YouTube SDK não ficou pronto');}},100); }); }

  ytLoad.addEventListener('click', async ()=>{
    showErr('');
    ensureCtx(); // gesto do usuário já existiu
    const parsed=parseYouTubeUrl(ytUrl.value);
    if(!parsed) return showErr('URL/ID/playlist inválida');
    try{
      await ytEnsureReady();
      if(parsed.list) player.loadPlaylist({list:parsed.list,listType:'playlist'});
      else player.loadVideoById(parsed.videoId);
    }catch(e){ showErr(e.message||e); }
  });

  ytTest.addEventListener('click', async ()=>{
    showErr('');
    ensureCtx();
    try{
      await ytEnsureReady();
      // vídeo oficial de demo da IFrame API
      player.loadVideoById('M7lc1UVf-VE');
    }catch(e){ showErr(e.message||e); }
  });

  ytPlay.addEventListener('click', ()=>{ if(!player) return; const s=player.getPlayerState();
    if(s===YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); });
  ytNext.addEventListener('click', ()=>{ if(!player) return; const pl=player.getPlaylist(); if(pl&&pl.length) player.nextVideo(); else player.seekTo(player.getCurrentTime()+10,true); });
  ytPrev.addEventListener('click', ()=>{ if(!player) return; const pl=player.getPlaylist(); if(pl&&pl.length) player.previousVideo(); else player.seekTo(Math.max(0,player.getCurrentTime()-10),true); });

  function updateMetadata(){ if(!player) return; const d=player.getVideoData(); if(d&&d.title) meta.textContent=d.title; }
  function startCoverPolling(){ coverInterval=setInterval(()=>{ if(!player) return; const d=player.getVideoData(); if(d&&d.video_id){ const url=`https://i.ytimg.com/vi/${d.video_id}/hqdefault.jpg`; if(cover.src!==url){ cover.src=url; cover.classList.add('show'); } updateMetadata(); } },1500); }

  // boot
  (async function boot(){
    try{
      await loadYouTubeAPI(); initPlayer();
    }catch(e){ showErr(e.message||e); }
  })();
  </script>
</body>
</html>
